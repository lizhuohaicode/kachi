<!DOCTYPE html>
<html>
  <head>
    <title>指定卡管理</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<link rel="stylesheet" type="text/css" href="../css/easyui/themes/default/easyui.css" rel="stylesheet" title="blue"/>
	<link rel="stylesheet" type="text/css" href="../css/easyui/themes/icon.css"/>
	<script type="text/javascript" src="../js/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../js/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../js/common.js"></script>
  </head>
  <body>
  	<form id="queryForm">
  		<table class="table">
  			<tr>
  				<th>终端编号：</th><td><input name="tsid" placeholder="请输入终端编号" class="onlyNumber"/></td>
  				<th>指定卡IMSI：</th><td><input name="imsi" placeholder="请输入指定卡IMSI" class="onlyNumber"/></td>
  				<td><a id="search_btn" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doQuery()">查 询</a></td>
  			</tr>
  		</table>
  	</form>
  	<div id="dg"></div>
  	<div id="doDialog" closed="true" style="padding:0 10px;overflow:auto;background:#FFF;" iconCls="icon-user">
		<form id="doForm">
			<table class="table th-normal appoint-card">
	  			<tr><th>终端编号：</th>
	  				<td><input name="tsid" class="easyui-validatebox" required="true" readonly="readonly" />
	  					<span class="btn-delete" onclick="showTerminal()">获取</span></td></tr>
	  			<tr><th>卡IMSI：</th>
	  				<td id="input_imsi"></td></tr>
	  			<tr><th>指定类型：</th><td><select name="type"><option value="0">临时指定</option><option value="1">一直指定</option></select></tr>
	  			<tr style="height:20px"></tr>
  			<tr><td colspan="2" align="center" class="noborder"><a  class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="saveData()">提 交</a></td></tr>
	  		</table>
		</form>
	</div>
	<div id="terminalDialog" closed="true" style="overflow:hidden;background:#FFF;" iconCls="icon-user">
		<form id="queryForm_t">
	  		<table class="table">
	  			<tr>
	  				<th>终端编号：</th><td><input name="tsid" placeholder="请输入终端编号" class="onlyNumber"/></td>
	  				<th>终端状态：</th>
	  				<td><select name="status">
		  					<option value="">全部</option><option value="0">正常</option><option value="1">未初始化</option>
		  					<option value="2">停用</option><option value="3">注销</option>
	  					</select>
	  				</td>
	  				<th>激活状态：</th>
	  				<td><select name="activated">
		  					<option value="">全部</option><option value="1">已激活</option><option value="0">未激活</option>
	  					</select>
	  				</td>
	  				<td><a id="search_btn" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doQuery_t()">查 询</a></td>
	  			</tr>
	  		</table>
	  	</form>
		<div id="terminalDg"></div>
	</div>
	<div id="cardDialog" closed="true" style="overflow:hidden;background:#FFF;" iconCls="icon-user">
		<form id="queryForm_c">
		  		<table class="table">
		  			<tr>
		  				<th>卡号：</th><td><input name="number" placeholder="请输入卡号" class="onlyNumber"/></td>
		  				<th>所在卡池：</th><td><select name="cpId"></select></td>
		  				<th>所属部门：</th><td><select name="departmentId"></select></td>
		  				<td><a id="search_btn" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doQuery_c()">查 询</a></td>
		  			</tr>
		  		</table>
		  	</form>
		<div id="cardDg"></div>
	</div>
  </body>
  <script type="text/javascript">
  var input_str = '<div><input type="hidden" name="idStatus" /><input name="imsi" readonly="readonly"/>'+
	  			  '		<span class="btn-delete" onclick="showCard()">获取</span><span class="btn-delete" onclick="removeInput(this)">删除</span></div>';
  var options={
			title:'指定卡列表',
			queryParams:$('#queryForm').serializeObject(),
			columns:[[
						{field:'ck',checkbox:true}, 
			         	{field:'id',title:'指定卡id',hidden:true},
			         	{field:'tsid',title:'终端编号',width:140},
			         	{field:'imsi',title:'IMSI',width:140},
			         	{field:'insertDate',title:'指定时间',width:150},
			         	{field:'lastStatus',title:'指定前卡状态',width:100,formatter:function(value,rec,index){
			         		var status = kcJs.fn.getCardStatus(value+'');
			         		return status?'<div style="border-radius:8px;color:#fff;width:90px;text-align:center;background:'+status[1]+'">'+status[0]+'</div>':'';
			         	}},
			         	{field:'operator',title:'操作人',width:100},
			         	{field:'type',title:'指定类型',width:150,formatter:function(value,rec,index){
			         		var status = kcJs.fn.getReadyType(value+'');
			         		return status?status[0]:'';
			         	}},
					]],
			toolbar: [{
				  		iconCls: 'icon-add',
				  		text:'添加',
				  		handler: doAdd
				  	  }
				  	 ],
			url:kcJs.fn.getContextPath()+'/getReadyTerminalSim',
			iconCls:'icon-tip',
			nowrap:false,
			pagination:true,
			pageList:[15,30],
			rownumbers:true,
			scrollbarSize:0,
			height:window.innerHeight*0.905
		};
    var terminal_options={
    		queryParams:$('#queryForm_t').serializeObject(),
			columns:[[
			         	{field:'id',title:'终端id',hidden:true},
			         	{field:'tsid',title:'终端编号',width:80},
			         	{field:'status',title:'活动状态',width:100,formatter:function(value,rec,index){
			         		var status = kcJs.fn.getTerminalStatus(value);
			         		return status?('<div style="border-radius:8px;color:#fff;width:90px;text-align:center;background:'+status[1]+'">'+status[0]+'</div>'):'';
			         	}},
			         	{field:'activated',title:'是否激活',width:60,formatter:function(value,rec,index){
			         		value+='';
			         		return value?(value=='0'?'否':(value=='1'?'是':'')):'';
			         	}},
			         	{field:'model',title:'终端型号',width:80},
			         	{field:'sVersion',title:'软件版本',width:80},
			         	{field:'upLog',title:'是否上传日志',width:100,formatter:function(value,rec,index){
			         		value+='';
			         		return value?(value=='0'?'否':(value=='1'?'是':'')):'';
			         	}},
			         	{field:'usedVpn',title:'是否支持VPN',width:80,formatter:function(value,rec,index){
			         		value+='';
			         		return value?(value=='0'?'否':(value=='1'?'是':'')):'';
			         	}},
			         	{field:'usedSoft',title:'是否支持软卡',width:80,formatter:function(value,rec,index){
			         		value+='';
			         		return value?(value=='0'?'否':(value=='1'?'是':'')):'';
			         	}},
			         	{field:'departmentName',title:'所属部门',width:150},
			         	{field:'countryName',title:'所在地区',width:120}
					]],
			url:kcJs.fn.getContextPath()+'/getTerminalByDept',
			iconCls:'icon-tip',
			nowrap:false,
			pagination:true,
			pageList:[15,30],
			rownumbers:true,
			scrollbarSize:0,
			height:315,
			onClickRow:function(rowIndex, rowData){
				$('#terminalDialog').dialog('close');
				$('#doForm [name="tsid"]').val(rowData.tsid);
			}
		};
	var card_options={
			queryParams:$('#queryForm_c').serializeObject(),
			columns:[[
						{field:'ck',checkbox:true}, 
			         	{field:'id',title:'SIM卡id',hidden:true},
			         	{field:'imsi',title:'imsi',width:120},
			         	{field:'number',title:'卡号',width:120},
			         	{field:'status',title:'卡状态',width:100,formatter:function(value,rec,index){
			         		var status = kcJs.fn.getCardStatus(value+'');
			         		return status?'<div style="border-radius:8px;color:#fff;width:90px;text-align:center;background:'+status[1]+'">'+status[0]+'</div>':'';
			         	}},
			         	{field:'operatorName',title:'运营商',width:90},
			         	{field:'packageName',title:'卡套餐',width:120},
			         	{field:'expiryDate',title:'有效期截卡时间',width:150},
			         	{field:'simPoolName',title:'所在卡池',width:100},
			         	{field:'cpChannelId',title:'卡池通道',width:80},
			         	{field:'departmentName',title:'所属部门',width:150}
					]],
			toolbar: [{
				  		iconCls: 'icon-save',
				  		text:'选取并关闭',
				  		handler: selectCards
				  	  }
				  	 ],
			url:kcJs.fn.getContextPath()+'/getSimCardsInAppointCard',
			nowrap:false,
			pagination:true,
			pageList:[15,30],
			rownumbers:true,
			scrollbarSize:0,
			height:315
		};
	$(function(){
		$('#dg').datagrid(options);
		$('#terminalDg').datagrid(terminal_options);
		
		$('#doDialog').dialog({
			modal : true,
 			width:400,
 			height:300,
 			cache: false,
			title : "添加指定卡信息"
		});
		
		$('#terminalDialog').dialog({
			modal : true,
 			width:1000,
 			height:400,
 			cache: false,
			title : "选取终端编号【单击可选中】"
		});
		
		$('#cardDialog').dialog({
			modal : true,
 			width:800,
 			height:400,
 			cache: false,
			title : "选取sim卡IMSI【可多选】"
		});
		
	});
	function doAdd(){//新增弹出窗
		$('#doForm')[0].reset();
		$('#input_imsi').html(input_str);
		$('#doDialog').dialog('open');
	}
	
	function doDelete(){
		var selectRows = $('#dg').datagrid("getSelections");
		if (selectRows.length > 0) {
			$.messager.confirm('提示','是否确定删除？',function(r){
				if(r){
					$('#dg').datagrid('loading');
		  			var ids = [];
		  			for(var i = 0;i < selectRows.length;i++){
		  				ids.push(selectRows[i].id);
		  			}
		  			$.post(kcJs.fn.getContextPath()+'/deleteReadyTerminalSim',{ids:ids.join(",")},function(data){
		  				if(data && data.code && data.code == '200'){
		  					doQuery();	
		  				}else{
		  					$('#dg').datagrid('loaded');
		  				}
		  				$.messager.alert("提示", data.msg, "info");
		  			},'json');
		  		}
			});
      }else {
          $.messager.alert("提示", "请选择至少一条信息", "info");
      }
	}
	
	function saveData(){//新增保存
		$('#doForm [name=imsi]').validatebox({
		    required: true
		});
		if($('#doForm').form('validate')){
			$('#doDialog').dialog('close');
			$('#dg').datagrid('loading');
			var args='';
			$('#doForm #input_imsi div').each(function(idx,obj){
				args += $('[name=idStatus]',$(this)).val()+','+$('[name=imsi]',$(this)).val()+';';
			});
			args = args.substr(0,args.length-1);
			var tsid = $('#doForm [name=tsid]').val();
			var type = $('#doForm [name=type]').val();
			$.post(kcJs.fn.getContextPath()+'/saveReadyTerminalSim',{args:args,tsid:tsid,type:type},function(data){
				if(data){
	    			$.messager.alert('提示',data.msg,'info');
	    			if(data.code=='200'){
	    				doQuery();
	    			}else{
	    				$('#dg').datagrid('loaded');
	    			}
	    		}
			}); 
		}
	}
	
	function doQuery(){
		options.queryParams = $('#queryForm').serializeObject();
		$('#dg').datagrid(options);
	}
	
	function removeInput(obj){
		if($('#doForm [name=imsi]').length > 1){
			$(obj).parent().remove();
		}else{
		   $('#doForm [name=imsi]').val('');
		   $('#doForm [name=idStatus]').val('');
		}
	}
	
	function showTerminal(){
		$('#terminalDialog').dialog('open');
	}
	
	function showCard(){
		$('#cardDg').datagrid(card_options);
		$('#cardDialog').dialog('open');
	}
	
	function selectCards(){
		var selectRows = $('#cardDg').datagrid("getSelections");
  		if (selectRows.length > 0) {
  			 for(var i = 0;i<selectRows.length;i++){
  			 	var rowData = selectRows[i];
  			 	var isExist = false;
  			 	$.each($('#doForm [name=imsi]'),function(idx,obj){
  			 		if(rowData.imsi == $(this).val()){
  			 			isExist = true;
  			 		}
  			 	});
  			 	if(!isExist){
  			 		if($('#doForm [name=imsi]').length>0 && $('#doForm [name=imsi]:eq(0)').val().length>0){
  			 			$('#input_imsi').append(input_str);
  			 		}
  			 		$('#doForm [name=imsi]:last').val(rowData.imsi);
  			 		$('#doForm [name=idStatus]:last').val(rowData.id+','+rowData.status);
  			 	}
  			 }
  		
             $('#cardDialog').dialog('close');
        }else {
            $.messager.alert("提示", "请选择其中一条信息", "info");
        }
	}
	function doQuery_t(){
		terminal_options.queryParams = $('#queryForm_t').serializeObject();
		$('#terminalDg').datagrid(terminal_options);
	}
	function doQuery_c(){
		card_options.queryParams = $('#queryForm_c').serializeObject();
		$('#cardDg').datagrid(card_options);
	}
  </script>
</html>	