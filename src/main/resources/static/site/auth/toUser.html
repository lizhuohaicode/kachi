<!DOCTYPE html>
<html>
  <head>
    <title>指定卡管理</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<link rel="stylesheet" type="text/css" href="../../css/easyui/themes/default/easyui.css" rel="stylesheet" title="blue"/>
	<link rel="stylesheet" type="text/css" href="../../css/easyui/themes/icon.css"/>
	<script type="text/javascript" src="../../js/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
  </head>
  <body id="main-layout" class="easyui-layout" style="overflow-y: hidden"  scroll="no">
  	
  	<div region="north" id="northDiv" style="height:45px;padding:0 2px;overflow-y:hidden;background:#FFF;" >
		<form id="queryForm">
	  		<table class="table">
	  			<tr>
	  				<th>登录名：</th><td><input name="loginName" placeholder="请输入登录名" /></td>
	  				<th>姓名：</th><td><input name="name" placeholder="请输入姓名" /></td>
	  				<th>代理商：</th><td><select name="departmentId" ></select></td>
	  				<th>账户状态：</th><td><select name="status" ><option value="">全部</option><option value="0">正常</option><option value="1">无效</option></select></td>
	  				<td><a id="search_btn" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doQuery()">查 询</a></td>
	  			</tr>
	  		</table>
	  	</form>
	</div>	
	<div region="center" title="" style="overflow:hidden;background:#FFF;padding:0 2px">
		<table id="dg" ></table>
	</div>
	
	<div id="doDialog" class="easyui-dialog" title="添加用户" closed="true" modal="true"  icon="icon icon-key" style="width:620px;height:430px;padding: 5px;">
		<div class="easyui-layout" fit="true">
			<div region="center" border="false" style="background: #fff;">
				<form id="doForm">
					<input type="hidden" name="id" id="id" />
					<fieldset>
						<legend>
							<br/> <span  class="do-title">基本信息</span>
						</legend>
						<table>
							<tr>
								<td class="user-td">姓名：<span class="flag">*</span></td>
								<td><input name="name" class="easyui-validatebox user-input" required="true" /></td>
								<td class="user-td">性别：</td>
								<td>
									<label><input type="radio" name="sex" value="1" checked="checked"/>&nbsp;男性</label>
									<label><input type="radio" name="sex" value="0" />&nbsp;女性</label>
								</td>
							</tr>
						</table>
					</fieldset>
					<fieldset>
						<legend>
							<br/><span class="do-title">账号信息</span>
						</legend>
						<table>
							<tr>
								<td class="user-td">登录名：<span class="flag">*</span></td>
								<td>
									<input name="loginName" class="easyui-validatebox user-input" required="true" validType="valiLoginName"/> 
								</td>
								<td class="user-td">所属部门：<span class="flag">*</span></td>
								<td><select name="departmentId" class="easyui-validatebox user-input user-select" required="true"></select></td>
							</tr>
							<tr id="hidePwd">
								<td class="user-td">密码：<span class="flag">*</span></td>
								<td><input id="pwd" name="passWord" class="easyui-validatebox user-input" required="true"/></td>
								<td class="user-td">确认密码：</td>
								<td>
									<input name="repeatPwd"  class="easyui-validatebox user-input" validType="equals['#pwd']" required="true"/>
								</td>
							</tr>
						</table>
					</fieldset>
					<fieldset>
						<legend>
							<br/><span class="do-title">其它信息</span>
						</legend>
						<table>
							<tr>
								<td class="user-td">手机号码：</td>
								<td><input name="phoneNumber" class="user-input onlyNumber" /></td>
								<td class="user-td">年龄：</td>
								<td><input name="age" class="user-input onlyNumber" /></td>
							</tr>
							<tr>
								<td class="user-td">QQ：</td>
								<td><input name="qq" class="user-input onlyNumber"/></td>
								<td class="user-td">微信：</td>
								<td><input name="wechat" class="user-input"/></td>
							</tr>
							<tr>
								<td class="user-td">邮箱：</td>
								<td><input name="email"  class="easyui-validatebox user-input"  validType="email" class="user-input"/></td>
							</tr>
						</table>
					</fieldset>
				</form>
			</div>
			<div region="south" border="false" style="text-align: right; height: 30px; background: #fff;">
				<a  class="easyui-linkbutton" icon="icon-ok"
					href="javascript:void(0)" onclick="saveUser()"> 确定</a> <a
					class="easyui-linkbutton" icon="icon-cancel"
					href="javascript:void(0)" onclick="$('#doDialog').dialog('close')">取消</a>
			</div>
		</div>
	</div>
  </body>
  <script type="text/javascript">
  	 $.ajaxSetup({async : false});
	  $.extend($.fn.validatebox.defaults.rules, {
	    equals: {
			validator: function(value,param){
				return value == $(param[0]).val();
			},
			message: '两次密码不一致'
	    },
	    valiLoginName:{
            validator:function(value,param){
                var type=false;
                $.getJSON(kcJs.fn.getContextPath()+'/getUserCount',{loginName:value},function(data){
                	type=(data==0);
                });
                return type;
            },
            message:'登录名已存在'
        }
	});
  	var options={
			title:'用户列表',
			queryParams:$('#queryForm').serializeObject(),
			columns:[[
						{field:'ck',checkbox:true}, 
			         	{field:'id',title:'id',hidden:true},
			         	{field:'loginName',title:'登录名',width:100},
			         	{field:'name',title:'姓名',width:100},
			         	{field:'sex',title:'性别',width:100,formatter:function(value,rec,index){
			         		return value=='1'?'男':(value=='0'?'女':'');
			         	}},
			         	{field:'phoneNumber',title:'手机号码',width:120},
			         	{field:'age',title:'年龄',width:80},
			         	{field:'qq',title:'QQ',width:100},
			         	{field:'wechat',title:'微信',width:100},
			         	{field:'email',title:'邮箱',width:100},
			         	{field:'departmentName',title:'代理商',width:150},
			         	{field:'status',title:'用户状态',width:100,formatter:function(value){
			         		var color = kcJs.fn.getColor((value+'')=="0"?"blue":"red");
			         		return '<div style="border-radius:8px;color:#fff;width:90px;text-align:center;background:'+color+'">'+(value=='0'?'正常':'封锁')+'</div>';
			         	}}
					]],
			toolbar: [
					  {text:"添加",iconCls:"icon-add",handler:doAdd},'-',
					  {text:"修改",iconCls:"icon-edit",handler:doModify},'-',
					  {text:"封锁用户",iconCls:"icon-lock",handler:doLock},'-',
					  {text:"解锁用户",iconCls:"icon-arrow-redo",handler:doUnlock},'-',
					  {text:"删除用户",iconCls:"icon-cancel",handler:doDelete}
					 ],
			url:kcJs.fn.getContextPath()+'/getUserList',
			iconCls:'icon-tip',
			nowrap:false,
			pagination:true,
			pageList:[15,30],
			rownumbers:true,
			striped:true,
			scrollbarSize:0,
			singleSelect:true,
			fit:true
		};
  
  	  var $loginName=null;
  	  function doQuery(){
  		options.queryParams = $('#queryForm').serializeObject();
  		$('#dg').datagrid(options);
  	  }
  
	  $(function(){
	  	$('#dg').datagrid(options);
	  	$loginName = $('#loginName1').clone();
	  	kcJs.fn.initSelect({"container":$('[name=departmentId]'),"url":'getDepartmentDic',"needNull":false});
	  });
	  
	  function doAdd(){
        $("#doForm [name=loginName]").attr("validType","valiLoginName");
		$("#doForm [name=passWord],#doForm [name=repeatPwd]").validatebox({ required: true });
	  
	  	$('#doForm')[0].reset();
	  	$('#doForm [name=id]').val('');
	  	$('#hidePwd').show();
	  	$('#doForm [name=departmentId],#doForm [name=loginName]').attr('disabled',false);
	  	$('#doDialog').dialog('open');
	  }
	  
	  function doModify(){
	  	var selectRows = $('#dg').datagrid("getSelections");
	  	if(selectRows && selectRows.length==1){
	        $("#doForm [name=loginName]").removeAttr("validType");
	        $("#doForm [name=loginName]").removeAttr("required");
	        $("#doForm [name=loginName]").removeAttr("class").addClass("user-input");
			$("#doForm [name=passWord],#doForm [name=repeatPwd]").validatebox({required: false});
			
	  		$('#doForm')[0].reset();
	  		$('#hidePwd').hide();
	  		$('#doForm [name=departmentId],#doForm [name=loginName]').attr('disabled',true);
		  	$('#doForm').form('load',selectRows[0]);
		  	$('#doDialog').dialog({title:'修改用户'});
		  	$('#doDialog').dialog('open');
	  	}else{
	  		$.messager.alert('提示','请选择其中一条数据','info');
	  	}
	  	
	  }
	  
	  function doLock(){
	  	var selectRows = $('#dg').datagrid("getSelections");
	  	if(selectRows && selectRows.length==1){
	  		updateStatus(selectRows[0].id,1);
	  	}else{
	  		$.messager.alert('提示','请选择其中一条数据','info');
	  	}
	  }
	  
	  function doUnlock(){
	  	var selectRows = $('#dg').datagrid("getSelections");
	  	if(selectRows && selectRows.length==1){
	  		updateStatus(selectRows[0].id,0);
	  	}else{
	  		$.messager.alert('提示','请选择其中一条数据','info');
	  	}
	  }
	  
	  function doDelete(){
	  	var selectRows = $('#dg').datagrid("getSelections");
	  	if(selectRows && selectRows.length==1){
	  		$('#dg').datagrid('loading');
		  	$.post(kcJs.fn.getContextPath()+'/deleteUser',{id:selectRows[0].id},function(data){
	  			$('#dg').datagrid('loaded');
	  			if(data && data.code=='200'){
	  				doQuery();
	  			}
	  			$.messager.alert('提示',data.msg,'info');
	  		});
	  	}else{
	  		$.messager.alert('提示','请选择其中一条数据','info');
	  	}
	  }
	  
	  function updateStatus(id,status){
	  	$('#dg').datagrid('loading');
	  	$.post(kcJs.fn.getContextPath()+'/updateUserStatus',{id:id,status:status},function(data){
  			$('#dg').datagrid('loaded');
  			if(data && data.code=='200'){
  				doQuery();
  			}
  			$.messager.alert('提示',data.msg,'info');
  		});
	  }
	  
	  function saveUser(){
	  	if($('#doForm').form('validate')){
  			$('#doDialog').dialog('close');
	  		$('#dg').datagrid('loading');
	  		$.post(kcJs.fn.getContextPath()+'/saveUser',$('#doForm').serializeObject(),function(data){
	  			$('#dg').datagrid('loaded');
	  			if(data && data.code=='200'){
	  				doQuery();
	  			}
	  			$.messager.alert('提示',data.msg,'info');
	  		});
	  	}
	  }
	  
  </script>
</html>	