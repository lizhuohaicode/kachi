<!DOCTYPE html>
<html>
  <head>
    <title>卡池管理</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="../css/easyui/themes/default/easyui.css" rel="stylesheet" title="blue"/>
	<link rel="stylesheet" type="text/css" href="../css/easyui/themes/icon.css"/>
	<script type="text/javascript" src="../js/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../js/jquery.tooltip.js"></script>
	<script type="text/javascript" src="../js/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../js/common.js"></script>
  </head>
  <body>
  	<div id="tt" class="easyui-tabs" >
	    <div title="概要信息" iconCls="icon icon-outline" style="padding:20px">
		    <table class="table kc-outline">
		    	<tr>
		    		<td><div class="kc-outline-number ligh-blue" id="simPoolCount"></div><div>卡池总数</div></td>
		    		<td><div class="kc-outline-number ligh-blue" id="onlinePoolCount"></div><div>在线卡池</div></td>
		    		<td><div class="kc-outline-number gray" id="offlinePoolCount"></div><div>离线卡池</div></td>
		    		<td><div class="kc-outline-number ligh-blue" id="cardSlotCount"></div><div>卡槽总数</div></td>
		    	</tr>
		    	<tr>
		    		<td><div class="kc-outline-number ligh-blue" id="simCardCount"></div><div>已插卡数</div></td>
		    		<td><div class="kc-outline-number red" id="noCardCount"></div><div>未插卡数</div></td>
		    		<td></td><td></td>
		    	</tr>
		    </table>
	    </div>
	    <div title="卡池设备" iconCls="icon icon-device" >
		  	<form id="queryForm">
		  		<table class="table">
		  			<tr>
		  				<th>卡池编号：</th><td><input name="spid" placeholder="请输入卡池编号" class="onlyNumber"/></td>
		  				<th>卡池名称：</th><td><input name="name" placeholder="请输入卡池名称"/></td>
		  				<th>卡池状态：</th>
		  				<td><select name="isActive"><option value="">全部</option><option  value="1">正常</option><option value="0">暂停</option></select></td>
		  				<td><a id="search_btn" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doQuery()">查 询</a></td>
		  			</tr>
		  		</table>
		  	</form>
		  	<div id="dg"></div>
		  	<div id="giveDialog" closed="true" style="padding:0 10px;overflow:auto;background:#FFF;" iconCls="icon-user">
		  		<form id="giveForm">
			  		<table class="table th-normal">
			  			<tr><th>卡池编号：</th><td><input name="spid" class="easyui-validatebox onlyNumber" required="true"/></td></tr>
			  			<tr><th>代理商：</th><td><select name="departmentId" class="easyui-validatebox" required="true"></select></td></tr>
			  			<tr style="height:20px"></tr>
			  			<tr><td colspan="4" align="center" class="noborder"><a  class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="saveData()">提 交</a></td></tr>
			  		</table>
		  		</form>
		  	</div>
		    <div id="cardsDialog" closed="true" style="padding:10px 20px;overflow:hidden;background:#FFF;" iconCls="icon-user">
		    	<div class="title"></div>
		    	<div class="card_container" ></div>
		    </div>
	    </div>
	</div>
  </body>
  <script type="text/javascript">
  	$('#tt').css('height',window.innerHeight*0.98+'px');
  	var options={
			title:'卡池设备列表',
			queryParams:$('#queryForm').serializeObject(),
			columns:[[
						{field:'ck',checkbox:true}, 
			         	{field:'id',title:'卡池id',hidden:true},
			         	{field:'spid',title:'卡池编号',width:80},
			         	{field:'name',title:'卡池名称',width:100},
			         	{field:'isActive',title:'活动状态',width:100,formatter:function(value,rec,index){
			         		var color = kcJs.fn.getColor(value=="1"?"blue":"red");
			         		return '<div style="border-radius:8px;color:#fff;width:90px;text-align:center;background:'+color+'">'+(value=="1"?"正常":"暂停")+'</div>';
			         	}},
			         	{field:'oupIp',title:'卡池外网IP',width:100},
			         	{field:'type',title:'卡池类型',width:100},
			         	{field:'mac',title:'卡池物理地址',width:120},
			         	{field:'version',title:'卡池版本',width:100},
			         	{field:'port',title:'卡池端口',width:100},
			         	{field:'departmentName',title:'所属部门',width:150}
					]],
			toolbar: [{
				  		iconCls: 'icon-yj-log',
				  		text:'查看卡信息',
				  		handler: doCardsInfo
				  	  },'-',{
				  		iconCls: 'icon-edit',
				  		text:'调整归属商',
				  		handler: doModifyDept
				  	  },'-',{
				  		iconCls: 'icon-add',
				  		text:'预分配卡池',
				  		handler: doGivePool
				  	  }
				  	 ],
			url:kcJs.fn.getContextPath()+'/getSimPoolByDept',
			iconCls:'icon-tip',
			nowrap:false,
			pagination:true,
			pageList:[15,30],
			rownumbers:true,
			scrollbarSize:0,
			height:window.innerHeight*0.82
		};
  
	$(function(){
		getCardPoolInfo();
	
		$('#dg').datagrid(options);
		
		$('#giveDialog').dialog({
			modal : true,
   			width:380,
   			height:180,
   			cache: false,
			title : "预分配卡池"
		});
		
		$('#cardsDialog').dialog({
			modal : true,
   			width:800,
   			height:350,
   			cache: false,
			title : "卡池对应卡信息"
		});
		
		kcJs.fn.initSelect({"container":$('#giveForm [name=departmentId]'),"url":'getDepartmentDic',"needNull":false});
	});
  
  	function doCardsInfo(){
  		var selectRows = $('#dg').datagrid("getSelections");
  		if (selectRows.length > 0 && selectRows.length == 1) {
             var rowData = $('#dg').datagrid("getSelected");
             $.getJSON(kcJs.fn.getContextPath()+'/getSimCardByPool/'+rowData.id,function(data){
             	var cardList = data.rows;
             	if(cardList && cardList.length>0){
             		$('.card_container').html('');
             		var total = rowData.type?rowData.type:cardList.length;
             		var count = 0;
             		for(var i = 0;i < total;i++){
             			var box = kcJs.fn.getCardStatus(5);
             			if((count < cardList.length) && ((i+1) == cardList[count].cpChannelId)){
             				box = kcJs.fn.getCardStatus(cardList[count].status);
             				count ++;
             			}
             			$('<div class="box" color="'+box[1]+'" style="background:'+box[1]+'"></div>').appendTo($('.card_container'))
             			.tooltip({
						    position: 'top',
						    content: '<div style="padding:5px 10px;color:#fff">通道编号：'+(i+1)+'<br>状态：'+box[0]+'</div>',
						    onShow: function(){
						    	//var color = $(this).attr('color');
								$(this).tooltip('tip').css({
									backgroundColor:$(this).attr('color'),
								});
						    }
						});	;
             		}
             		$('.title').html(rowData.name+' （'+rowData.type+'）');
             		$('#cardsDialog').dialog('open');
             	}
             });
        }
        else {
            $.messager.alert("提示", "请选择其中一条信息", "info");
        }
  	}
  	
  	function doModifyDept(){
  		
  	}
  	
  	function doQuery(){
  		options.queryParams = $('#queryForm').serializeObject();
  		$('#dg').datagrid(options);
  	}
  	
  	function doGivePool(){
		$('#giveForm')[0].reset();
  		$('#giveDialog').dialog('open');
	}
  	
  	function getCardPoolInfo(){
  		$.post(kcJs.fn.getContextPath()+'/getPoolOutlineInfo',function(data){
  			if(data && data.code=='200'){
  				var info = data.data;
  				$('#simPoolCount').text(info.simPoolCount);
  				$('#onlinePoolCount').text(info.onlinePoolCount);
  				$('#offlinePoolCount').text(info.offlinePoolCount);
  				$('#cardSlotCount').text(info.cardSlotCount);
  				$('#simCardCount').text(info.simCardCount);
  				$('#noCardCount').text(info.cardSlotCount-info.simCardCount);
  			}
  		},'json');
  	}
  	
  	function saveData(){
  		if($('#giveForm').form('validate')){
  			$('#giveDialog').dialog('close');
  			$('#dg').datagrid('loading');
  			$.post(kcJs.fn.getContextPath()+'/giveSimPool',$('#giveForm').serializeObject(),function(data){
  				if(data){
	    			$.messager.alert('提示',data.msg,'info');
	    			$('#dg').datagrid('loaded');
		    	}
  			}); 
  		}
  	}
  </script>
</html>
